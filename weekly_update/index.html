<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¶¦å­¦å‘¨æŠ¥ - æ°¸ä¸å¤±è”</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+SC:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724; /* dark navy */
      --card:#0b1220;
      --accent:#6ea8fe;
      --muted:rgba(255,255,255,0.65);
      --glass: rgba(255,255,255,0.04);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: 'Source Han Sans CN', 'Noto Sans SC', 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
                   'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', 'Twemoji Mozilla', 'EmojiOne Color', 'Android Emoji', sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(110,168,254,0.08), transparent),
                  linear-gradient(180deg, var(--bg), #071224 60%);
      margin: 0;
      padding: 40px 20px;
      color: #e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:940px;
      margin:0 auto;
    }
    .banner{
      position:fixed;
      top:0;left:0;right:0;
      background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom:1px solid rgba(255,255,255,0.04);
      padding:10px 20px;
      z-index:100;
    }
    .wrap{padding-top:72px}
    .brand{display:flex;align-items:center;justify-content:space-between}
    .brand-text{font-weight:600;color:#e6eef8}
    h1{font-size:20px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}
    .nav{display:flex;gap:8px;align-items:center}
    .nav-item{
      padding:8px 16px;
      border-radius:10px;
      text-decoration:none;
      color:var(--muted);
      font-weight:500;
      font-size:14px;
      transition:all 0.2s ease;
      border:1px solid transparent;
    }
    .nav-item:hover{
      background:rgba(255,255,255,0.05);
      color:#e6eef8;
    }
    .nav-item.active{
      background:linear-gradient(90deg,var(--accent),#7dd3fc);
      color:#04263b;
      font-weight:600;
    }

    /* main should be a layout container (not a card) so inner .card elements are the visible panels */
    main{
      display: grid;
      gap: 24px;
      margin-bottom: 28px;
      background: transparent;
      padding: 0;
      border: 0;
      box-shadow: none;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      padding:28px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    .hero{ text-align:center; padding:40px 20px }
    .hero h2{ font-size:32px; margin:0 0 16px 0; background:linear-gradient(135deg,var(--accent),#7dd3fc); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .hero p{ font-size:16px; color:var(--muted); margin:0; }

    .issue-list{
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .issue{
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:10px;
      padding:20px;
      transition:transform 0.2s ease, background 0.2s ease;
    }
    .issue:hover{
      transform:translateY(-2px);
      background:rgba(255,255,255,0.03);
    }
    .issue-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .issue-title{
      font-size:18px;
      font-weight:600;
      margin:0;
    }
    .issue-date{
      color:var(--muted);
      font-size:13px;
    }
    .issue-summary{
      color:var(--muted);
      line-height:1.6;
      margin-bottom:16px;
    }
    .issue-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:8px;
      background:linear-gradient(90deg,var(--accent),#7dd3fc);
      color:#04263b;
      text-decoration:none;
      font-weight:600;
      font-size:14px;
      transition:transform 0.2s ease;
    }
    .issue-link:hover{
      transform:translateY(-1px);
    }

    .control-panel{
      background:transparent;
      border:0;
      padding:24px 0 8px 0;
      margin-bottom:12px;
      display:grid;
      grid-template-columns:1fr 1fr auto;
      gap:24px;
      align-items:end;
    }
    .control-panel label{
      display:block;
      font-size:14px;
      font-weight:600;
      color:#e6eef8;
      margin-bottom:8px;
    }
    .issue-selector{
      display:flex;
      flex-direction:column;
    }
    .issue-select{
      padding:10px 14px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.02);
      color:#e6eef8;
      font-size:14px;
      font-weight:500;
      min-width:200px;
      transition:all 0.2s ease;
    }
    .issue-select:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,255,255,0.05);
    }
    .issue-select option{
      background:#1a2332;
      color:#e6eef8;
      padding:8px;
    }
    

    /* current-issue should not have an extra card border when wrapped by outer .card */
    .current-issue{ background:transparent; border:0; padding:0; margin-top:12px }

    .refresh-btn{
      padding:10px 16px;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      background:rgba(255,255,255,0.02);
      color:var(--muted);
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all 0.2s ease;
      white-space:nowrap;
    }
    .refresh-btn:hover{
      background:rgba(255,255,255,0.05);
      border-color:var(--accent);
      color:#e6eef8;
    }
    
    .news-item{
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:10px;
      padding:20px;
      transition:all 0.2s ease;
    }
    .news-item:hover{
      transform:translateY(-2px);
      background:rgba(255,255,255,0.03);
      border-color:rgba(110,168,254,0.3);
    }
    .news-item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .news-item-date{
      font-size:16px;
      font-weight:600;
      margin:0;
    }
    .news-item-actions{
      display:flex;
      gap:8px;
    }
    .news-item-btn{
      padding:6px 12px;
      border-radius:6px;
      text-decoration:none;
      font-size:12px;
      font-weight:600;
      transition:all 0.2s ease;
    }
    .btn-view{
      background:linear-gradient(90deg,var(--accent),#7dd3fc);
      color:#04263b;
    }
    .btn-raw{
      background:rgba(255,255,255,0.05);
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.1);
    }
    .news-item-btn:hover{
      transform:translateY(-1px);
    }
    .news-item-preview{
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
      margin:0;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:3;
      line-clamp:3;
      -webkit-box-orient:vertical;
    }

    .current-issue{
      background:rgba(255,255,255,0.01);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:12px;
      overflow:hidden;
    }
    .current-issue-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:20px 24px;
      background:rgba(255,255,255,0.02);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .current-issue-header h3{
      margin:0;
      font-size:18px;
      color:#e6eef8;
    }
    .issue-actions{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .view-btn{
      padding:6px 12px;
      border-radius:6px;
      text-decoration:none;
      font-size:12px;
      font-weight:600;
      transition:all 0.2s ease;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .view-btn.secondary{
      background:rgba(255,255,255,0.05);
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.1);
    }
    .view-btn:hover{
      transform:translateY(-1px);
    }

    .issue-frame-container{
      position:relative;
      height:75vh;
      min-height:500px;
    }
    .issue-content{
      width:100%;
      height:100%;
      padding:20px;
      overflow:auto; /* allow scrolling */
      color:var(--muted);
      background:transparent;
    }
    .loading-indicator{
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:rgba(15,23,36,0.9);
      z-index:10;
    }
    .loading-indicator.hidden{
      display:none;
    }
    .spinner{
      width:32px;
      height:32px;
      border:3px solid rgba(255,255,255,0.1);
      border-top:3px solid var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:12px;
    }
    .loading-indicator p{
      color:var(--muted);
      margin:0;
      font-size:14px;
    }
    .issue-frame{
      width:100%;
      height:100%;
      border:none;
      background:#fff;
      border-radius:0 0 12px 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .guide-steps{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .step{
      display:flex;
      gap:16px;
      align-items:flex-start;
    }
    .step-number{
      width:28px;
      height:28px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--accent),#7dd3fc);
      color:#04263b;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:14px;
      flex:0 0 28px;
    }
    .step-content{
      flex:1;
    }
    .step-content strong{
      display:block;
      margin-bottom:4px;
      color:#e6eef8;
    }
    .open-renderer-btn{
      padding:6px 12px;
      border-radius:6px;
      text-decoration:none;
      font-size:12px;
      font-weight:600;
      transition:all 0.2s ease;
      display:none;
      background:rgba(255,255,255,0.05);
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.1);
    }
    .open-renderer-btn.show{ display:inline-flex; }
    .step-content p{
      margin:0;
      font-size:14px;
    }
    .step-content code{
      background:rgba(255,255,255,0.1);
      padding:2px 6px;
      border-radius:4px;
      font-family:monospace;
      font-size:13px;
    }

    footer{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      margin-top:40px;
    }

    @media (max-width:880px){
      header{flex-direction:column;align-items:flex-start}
      .nav{
        width:100%;
        justify-content:center;
        margin-top:12px;
      }
      main{padding:20px}
      .weekly-header h2{font-size:24px}
      .control-panel{
        grid-template-columns:1fr;
        gap:16px;
      }
      .current-issue-header{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      .issue-actions{
        width:100%;
        justify-content:flex-start;
      }
      .issue-frame-container{
      .open-renderer-btn{
        padding:6px 12px;
        border-radius:6px;
        text-decoration:none;
        font-size:12px;
        font-weight:600;
        transition:all 0.2s ease;
        display:none;
        background:rgba(255,255,255,0.05);
        color:var(--muted);
        border:1px solid rgba(255,255,255,0.1);
      }
      .open-renderer-btn.show{ display:inline-flex; }
        height:60vh;
        min-height:400px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner">
      <div class="brand">
        <div class="brand-text">æ¶¦å­¦å‘¨æŠ¥ - æ°¸ä¸å¤±è”</div>
        <nav class="nav">
          <a href="/" class="nav-item">ä¸»é¡µ</a>
          <a href="/weekly_update/" class="nav-item active">æ¶¦å­¦å‘¨æŠ¥</a>
          <a href="/about/" class="nav-item">å…³äº</a>
        </nav>
      </div>
    </div>

    <main>
      <div class="card hero">
        <h2>æ¶¦å­¦å‘¨æŠ¥</h2>
        <p>æ¯å‘¨ä¸ºä½ ç²¾é€‰æ¶¦å­¦ç›¸å…³çš„æœ€æ–°èµ„è®¯ã€æ”¿ç­–å˜åŒ–ã€ç»éªŒåˆ†äº«å’Œå®ç”¨å·¥å…·</p>
      </div>
      <div class="card">
        <!-- æœŸåˆŠé€‰æ‹©å™¨ -->
        <div class="issue-selector">
          <h3>é€‰æ‹©æœŸåˆŠ</h3>
          <div class="selector-container">
            <select id="issueSelect" class="issue-select">
              <option value="">æ­£åœ¨åŠ è½½æœŸåˆŠåˆ—è¡¨...</option>
            </select>
            <button id="refreshBtn" class="refresh-btn" title="åˆ·æ–°æœŸåˆŠåˆ—è¡¨">ğŸ”„</button>
          </div>
        </div>

        <!-- å½“å‰æ˜¾ç¤ºçš„æœŸåˆŠ -->
        <div class="current-issue">
          <div class="current-issue-header">
            <h3 id="currentIssueTitle">ğŸ“° æ¶¦å­¦å‘¨æŠ¥</h3>
            <div class="issue-actions">
              <a id="viewRaw" href="#" target="_blank" class="view-btn secondary">ğŸ“„ æŸ¥çœ‹æºç </a>
            </div>
          </div>
          <div class="issue-frame-container">
            <div id="loadingIndicator" class="loading-indicator">
              <div class="spinner"></div>
              <p>æ­£åœ¨åŠ è½½æœŸåˆŠå†…å®¹...</p>
            </div>
            <!-- æ¸²æŸ“å®¹å™¨ï¼šä½¿ç”¨å‰ç«¯ fetch + marked æ¸²æŸ“ Markdown å†…å®¹ -->
            <div id="issueContent" class="issue-content markdown-body"></div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2024 æ¶¦å­¦å‘¨æŠ¥ - æ°¸ä¸å¤±è”é¡¹ç›®</p>
    </footer>
  </div>

  <script>
    // å¼•å…¥ markedï¼ˆç”¨äº Markdown åˆ° HTML æ¸²æŸ“ï¼‰
  </script>
  <script>
    // åŠ¨æ€åŠ è½½è„šæœ¬ï¼Œä¼˜å…ˆæœ¬åœ° vendorï¼Œå¤±è´¥å›é€€åˆ°å¤šä¸ª CDN
    function loadScriptSeq(urls, check, done){
      const tryNext = (i)=>{
        if(i>=urls.length){ done(new Error('All sources failed')); return; }
        const s=document.createElement('script');
        s.src=urls[i]; s.defer=true; s.onload=()=>{ try{ if(!check||check()) return done(); }catch(e){} tryNext(i+1); };
        s.onerror=()=>tryNext(i+1);
        document.head.appendChild(s);
      };
      tryNext(0);
    }
    function loadStyleSeq(urls, done){
      const tryNext = (i)=>{
        if(i>=urls.length){ done&&done(new Error('All styles failed')); return; }
        const l=document.createElement('link'); l.rel='stylesheet'; l.href=urls[i];
        l.onload=()=>done&&done(); l.onerror=()=>tryNext(i+1);
        document.head.appendChild(l);
      };
      tryNext(0);
    }
    async function ensureLibsLoaded(){
      return new Promise((resolve)=>{
        loadScriptSeq([
          '/assets/vendor/marked.min.js',
          'https://cdn.jsdelivr.net/npm/marked/marked.min.js',
          'https://unpkg.com/marked/marked.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js'
        ], ()=>window.marked, ()=>{
          loadScriptSeq([
            '/assets/vendor/purify.min.js',
            'https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js',
            'https://unpkg.com/dompurify@2.4.0/dist/purify.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js'
          ], ()=>window.DOMPurify, ()=>{
            loadStyleSeq([
              '/assets/vendor/github.min.css',
              'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/styles/github.min.css',
              'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css'
            ]);
            loadScriptSeq([
              '/assets/vendor/highlight.min.js',
              'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js'
            ], ()=>window.hljs, ()=>{ try{ hljs.configure({ignoreUnescapedHTML:true}); }catch(e){} resolve(); });
          });
        });
      });
    }
  </script>
  <style>
    /* Basic GitHub-like markdown styling (light weight) */
    .markdown-body{ background:transparent; color:#e6eef8; }
    .markdown-body h1,.markdown-body h2,.markdown-body h3{ color:#e6eef8 }
    .markdown-body p{ color:var(--muted); line-height:1.8; margin: 0.6em 0 }
    .markdown-body a{ color: var(--accent); text-decoration: underline; }
    .markdown-body a:hover{ color:#7dd3fc; text-decoration: none; }
    .markdown-body pre{ background:#071224; padding:12px; border-radius:8px; overflow:auto }
    .markdown-body code{ background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:6px }
    .markdown-body table{ border-collapse:collapse; width:100%; }
    .markdown-body th, .markdown-body td{ border:1px solid rgba(255,255,255,0.08); padding:8px }
    .markdown-body th{ background: rgba(255,255,255,0.04); color:#e6eef8 }
    .markdown-body tr:nth-child(even){ background: rgba(255,255,255,0.02) }
    .markdown-body blockquote{ border-left:4px solid rgba(255,255,255,0.04); padding-left:12px; color:var(--muted) }
    .markdown-body img{ max-width:100%; height:auto; border-radius:6px }
    .markdown-body ul, .markdown-body ol{ padding-left: 1.4em }
    .markdown-body li+li{ margin-top: 0.3em }
    .markdown-body input[type="checkbox"]{ margin-right:8px; transform: scale(1.05); }
    .markdown-body .task-list-item{ list-style: none; }
  </style>
  <script>
    // ä½¿ç”¨å•ä¸€æ¸²æŸ“å™¨ï¼šMarked é¡µé¢å†…æ¸²æŸ“
    const RENDERERS = [ { name: 'Marked', default: true } ];

    // å…¨å±€çŠ¶æ€
    let currentRenderer = RENDERERS.find(r => r.default) || RENDERERS[0];
    let currentFile = null;
    let availableFiles = [];

    // ç”Ÿæˆæ—¥æœŸåˆ—è¡¨ï¼ˆæœ€è¿‘60å¤©ï¼‰
    function generateDateList() {
      const dates = [];
      const today = new Date();
      
      for (let i = 0; i < 60; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateStr = date.toISOString().split('T')[0]; // yyyy-mm-ddæ ¼å¼
        dates.push(dateStr);
      }
      
      return dates.sort().reverse(); // æœ€æ–°çš„åœ¨å‰
    }

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    async function checkFileExists(filename) {
      try {
        const response = await fetch(`storage/${filename}`, { method: 'HEAD' });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
    function formatDateDisplay(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `æ¶¦å­¦å‘¨æŠ¥ - ${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    // æ‰«æå¯ç”¨çš„æ–‡ä»¶
    async function scanAvailableFiles() {
      const dates = generateDateList();
      const files = [];
      
      for (const date of dates) {
        const filename = `${date}.md`;
        if (await checkFileExists(filename)) {
          files.push({
            date,
            filename,
            display: formatDateDisplay(date)
          });
        }
      }
      
      return files.sort((a, b) => b.date.localeCompare(a.date)); // æœ€æ–°çš„åœ¨å‰
    }

    // å·²ç§»é™¤æ¸²æŸ“å™¨åˆ‡æ¢ç›¸å…³å‡½æ•°

    // æ¸²æŸ“æœŸåˆŠé€‰æ‹©ä¸‹æ‹‰æ¡†
    function renderIssueSelect() {
      const select = document.getElementById('issueSelect');
      if (!select) return;

      if (availableFiles.length === 0) {
        select.innerHTML = '<option value="">æš‚æ— å¯ç”¨æœŸåˆŠ</option>';
        return;
      }

      select.innerHTML = availableFiles.map(file => 
        `<option value="${file.filename}" ${file === currentFile ? 'selected' : ''}>
          ${file.display}
        </option>`
      ).join('');

      // æ·»åŠ é€‰æ‹©äº‹ä»¶
      select.addEventListener('change', (e) => {
        const filename = e.target.value;
        const file = availableFiles.find(f => f.filename === filename);
        if (file) {
          loadFile(file);
        }
      });
    }

    // é€‰æ‹©å¯ç”¨çš„æ¥æºï¼šä¼˜å…ˆå°è¯• jsDelivr CDNï¼ˆå¿«é€Ÿã€ç¼“å­˜å‹å¥½ï¼‰ï¼Œè‹¥ CDN ä¸å¯ç”¨åˆ™å›é€€åˆ° raw.githubusercontent
    async function chooseSourceUrl(filename) {
      const cdnUrl = `https://cdn.jsdelivr.net/gh/zhenmunse/run_global@main/weekly_update/storage/${filename}`;
      const rawUrl = `https://raw.githubusercontent.com/zhenmunse/run_global/main/weekly_update/storage/${filename}`;

      // å°å·¥å…·ï¼šå°è¯• HEAD è¯·æ±‚æ£€æŸ¥èµ„æºå¯ç”¨æ€§
      async function headOk(url) {
        try {
          const res = await fetch(url, { method: 'HEAD' });
          return res && res.ok;
        } catch (e) {
          return false;
        }
      }

      // å…ˆæ£€æŸ¥ CDNï¼Œå†æ£€æŸ¥ rawï¼›å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œè¿”å› null
      if (await headOk(cdnUrl)) {
        return { type: 'cdn', url: cdnUrl };
      }

      if (await headOk(rawUrl)) {
        return { type: 'raw', url: rawUrl };
      }

      return null;
    }

    // åŠ è½½æ–‡ä»¶å¹¶åœ¨é¡µé¢å†…æ¸²æŸ“ Markdownï¼ˆä¼˜å…ˆ CDNï¼Œå›é€€ RAWï¼‰
    async function loadFile(file) {
      currentFile = file;

      // æ›´æ–°æ ‡é¢˜
      const titleElement = document.getElementById('currentIssueTitle');
      if (titleElement) {
        titleElement.textContent = `ğŸ“° ${file.display}`;
      }

      // æ›´æ–°æºç é“¾æ¥ï¼ˆå§‹ç»ˆæŒ‡å‘ rawï¼Œä»¥ä¾¿ç”¨æˆ·ç›´æ¥æ‰“å¼€åŸå§‹ Markdownï¼‰
      const rawLink = document.getElementById('viewRaw');
      if (rawLink) {
        rawLink.href = `https://raw.githubusercontent.com/zhenmunse/run_global/main/weekly_update/storage/${file.filename}`;
      }

      showLoading();
      const contentEl = document.getElementById('issueContent');
      if (!contentEl) {
        hideLoading();
        return;
      }

      // é€‰æ‹©åˆé€‚çš„æºï¼ˆcdn/rawï¼‰
      const chosen = await chooseSourceUrl(file.filename);

      if (!chosen) {
        hideLoading();
        showError('æ— æ³•ä» CDN æˆ– RAW è·å–æ–‡ä»¶ï¼Œè¯·ç¨åé‡è¯•');
        return;
      }

      // ç°åœ¨ç»Ÿä¸€ä½¿ç”¨é¡µé¢å†… marked æ¸²æŸ“ï¼šfetch -> marked -> DOMPurify -> insert -> highlight
      try {
        const resp = await fetch(chosen.url);
        if (!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);
        const md = await resp.text();

        // ä½¿ç”¨ marked æ¸²æŸ“ä¸º HTML
        const rawHtml = (typeof marked !== 'undefined' && marked && typeof marked.parse === 'function') ? marked.parse(md) : `<pre>${md}</pre>`;

        // ä½¿ç”¨ DOMPurify æ¸…ç† HTML
        const clean = (typeof DOMPurify !== 'undefined' && DOMPurify) ? DOMPurify.sanitize(rawHtml) : rawHtml;

        contentEl.innerHTML = clean;

        // ä½¿ç”¨ highlight.js é«˜äº®ä»£ç å—
        if (typeof hljs !== 'undefined' && hljs) {
          contentEl.querySelectorAll('pre code').forEach((block) => {
            try { hljs.highlightElement(block); } catch (e) { /* ignore */ }
          });
        }

        hideLoading();
      } catch (err) {
        console.error('é¡µé¢å†…æ¸²æŸ“å¤±è´¥:', err);
        hideLoading();
        showError('é¡µé¢å†…æ¸²æŸ“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
      }

      // æ›´æ–°é€‰æ‹©æ¡†çŠ¶æ€
      const select = document.getElementById('issueSelect');
      if (select) {
        select.value = file.filename;
      }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
      const loading = document.getElementById('loadingIndicator');
      if (loading) {
        loading.classList.remove('hidden');
      }
    }

    // éšè—åŠ è½½çŠ¶æ€
    function hideLoading() {
      const loading = document.getElementById('loadingIndicator');
      if (loading) {
        loading.classList.add('hidden');
      }
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      const loading = document.getElementById('loadingIndicator');
      if (loading) {
        loading.innerHTML = `
          <div style="color: #ff6b6b;">
            <p>âŒ ${message}</p>
            <button onclick="location.reload()" style="padding:8px 16px;margin-top:12px;border-radius:6px;border:1px solid #ff6b6b;background:transparent;color:#ff6b6b;cursor:pointer;">
              é‡æ–°åŠ è½½
            </button>
          </div>
        `;
      }
    }

    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    async function refreshFileList() {
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
      }

      try {
        availableFiles = await scanAvailableFiles();
        renderIssueSelect();
        
        // å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­æ–‡ä»¶ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€æ–°çš„
        if (!currentFile && availableFiles.length > 0) {
          loadFile(availableFiles[0]);
        }
      } catch (error) {
        console.error('åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        showError('åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      } finally {
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°åˆ—è¡¨';
        }
      }
    }

    // åˆå§‹åŒ–é¡µé¢
    async function initPage() {
      // ç¡®ä¿æ¸²æŸ“ä¾èµ–ï¼ˆmarked/DOMPurify/hljsï¼‰å·²åŠ è½½
      if (typeof ensureLibsLoaded === 'function') {
        try { await ensureLibsLoaded(); } catch(e) { console.warn('åº“åŠ è½½å¯èƒ½ä¸å®Œæ•´ï¼Œä½†ç»§ç»­è¿è¡Œ'); }
      }

      // æ‰«æå¹¶åŠ è½½æ–‡ä»¶åˆ—è¡¨
      await refreshFileList();
      
      // ç»‘å®šåˆ·æ–°æŒ‰é’®
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshFileList);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>