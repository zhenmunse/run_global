<template>
  <div class="wrap">
    <main>
      <div class="card hero">
        <h2>æ¶¦ç‰©æœ‰å£°</h2>
        <h3>è‡´åŠ›äºæ‰“é€ æ–°ç”Ÿä»£æµ·å¤–åäººäº’åŠ©ç¤¾ç¾¤</h3>
        <p>æˆ‘ä»¬æ­å»ºä¸€ä¸ªä½é—¨æ§›ã€é«˜å¯†åº¦ã€å¿«é€Ÿå“åº”çš„ç¤¾ç¾¤å¹³å°ï¼Œè®©éœ€è¦ä¿¡æ¯å’Œç»éªŒçš„äººèƒ½åŠæ—¶è·å¾—å¸®åŠ©ä¸æŒ‡å¼•ã€‚</p>
      </div>

      <div class="card content">
        <h3>ğŸ¯ æˆ‘ä»¬çš„ä½¿å‘½</h3>
        <p>åœ¨ä¿¡æ¯ä¼ æ’­æ—¥ç›Šé‡è¦çš„ä»Šå¤©ï¼Œæˆ‘ä»¬æ·±çŸ¥ä¿¡æ¯å·®çš„æ‰“ç ´å¯¹æ™®é€šå®¶åº­æ„å‘³ç€ä»€ä¹ˆï¼Œä½†ä¼ ç»Ÿçš„ Reddit ç­‰ç½‘ç«™å­˜åœ¨è·å–æˆæœ¬è¾ƒé«˜ã€ä¿¡æ¯å¯†åº¦ä½ã€æ»åæ€§ç­‰é—®é¢˜ã€‚</p>
        <p>å› æ­¤ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€æ¬¾â€œæ°¸ä¸å¤±è”â€çš„ç¤¾ç¾¤å¹³å°ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡æœ¬å¹³å°åŠ å…¥ç¾¤èŠï¼Œä»¥è·å¾—æœ€æ–°çš„ç•™å­¦ã€ç§»æ°‘ç›¸å…³åŠ¨æ€ï¼Œä¸ä¸–ç•Œå„åœ°çš„ç¾¤å‹åˆ†äº«å„ä¸ªå›½å®¶çš„ç»éªŒã€æ„Ÿæ‚Ÿä¸å®ç”¨ä¿¡æ¯ã€‚</p>
        <p>æˆ‘ä»¬ç›¸ä¿¡ï¼Œé€šè¿‡å›¢é˜Ÿä¸å¹¿å¤§ç¾¤å‹çš„åŠªåŠ›ï¼Œå¯ä»¥å…±åŒæ‰“é€ å‡ºæœ€å¤§ã€æœ€æ´»è·ƒçš„æ–°ç”Ÿä»£æµ·å¤–åäººäº’åŠ©ç¤¾ç¾¤ã€‚</p>
      </div>

      <div class="card content">
        <h3>ğŸ’¡ ä¸»è¦ç‰¹è‰²</h3>
        <div class="features">
          <div class="feature">
            <div class="feature-icon">ğŸ”—</div>
            <h4>å¤šæ¸ é“å¤‡ä»½</h4>
            <p>ç»´æŠ¤å¤šä¸ªQQç¾¤ä½œä¸ºå¤‡ä»½è”ç³»æ¸ é“ï¼Œé™ä½å•ç‚¹å¤±è”é£é™©ã€‚</p>
          </div>
          <div class="feature">
            <div class="feature-icon">ğŸŒ</div>
            <h4>ç½‘é¡µå¤‡ä»½</h4>
            <p>æä¾›ç½‘é¡µç‰ˆç¾¤é“¾æ¥ä¸ç›®å½•ï¼Œä¾¿äºåœ¨ä¸åŒè®¾å¤‡ä¸ç¯å¢ƒä¸‹å¿«é€Ÿæ‰¾åˆ°å…¥å£ã€‚</p>
          </div>
          <div class="feature">
            <div class="feature-icon">ğŸ“°</div>
            <h4>å®šæœŸèµ„è®¯</h4>
            <p>é€šè¿‡æ¶¦å­¦å‘¨æŠ¥å®šæœŸæ•´ç†å¹¶åˆ†äº«æœ€æ–°æ¶ˆæ¯ã€ç»éªŒä¸å¯æ‰§è¡Œçš„å»ºè®®ã€‚</p>
          </div>
          <div class="feature">
            <div class="feature-icon">ğŸ¤</div>
            <h4>ç¤¾åŒºäº’åŠ©</h4>
            <p>å»ºç«‹å‹å–„ã€å¯†é›†çš„äº¤æµç©ºé—´ï¼Œé¼“åŠ±ç»éªŒåˆ†äº«ä¸ç›¸äº’å¸®åŠ©ã€‚</p>
          </div>
        </div>
      </div>

      <div class="card content">
        <h3>ğŸ“Š ç¾¤ç»„åˆ†ç±»</h3>
        <p>æˆ‘ä»¬æ ¹æ®ä¸åŒçš„åœ°åŒºå’Œè¯­è¨€éœ€æ±‚ï¼Œå»ºç«‹äº†å¤šä¸ªä¸“é—¨çš„äº¤æµç¾¤ç»„ï¼Œæ–¹ä¾¿å¤§å®¶æ‰¾åˆ°æœ€é€‚åˆçš„è®¨è®ºç¯å¢ƒï¼š</p>
        <p><strong>ä¸»ç¾¤ï¼š</strong> ç»¼åˆæ€§äº¤æµï¼Œé€‚åˆæ‰€æœ‰ç”¨æˆ·ã€‚</p>
        <p><strong>åœ°åŒºç¾¤ï¼š</strong> ç¾å›½/åŠ æ‹¿å¤§ã€æ¾³æ´²/æ–°è¥¿å…°ã€æ—¥æœ¬ã€å¾·å›½ç­‰åœ°åŒºæ€§ç¾¤ç»„ï¼Œèšç„¦å½“åœ°æ”¿ç­–ã€ç”Ÿæ´»ä¸ç»éªŒåˆ†äº«ã€‚</p>
        <p><strong>è¯­è¨€ç¾¤ï¼š</strong> æ—¥è¯­ã€å¾·è¯­ç­‰è¯­è¨€å­¦ä¹ ä¸æ–‡åŒ–äº¤æµç¾¤ç»„ï¼Œä¾¿äºå­¦ä¹ è€…äº’ç›¸æ”¯æŒã€‚</p>
        <p>å¦‚æœæ‚¨æœ‰æ–°çš„ç»†åˆ†é¢†åŸŸç¾¤ç»„å»ºç«‹éœ€æ±‚ï¼Œä¹Ÿæ¬¢è¿è”ç³»ç®¡ç†å›¢é˜Ÿè®¨è®ºï¼Œæˆ‘ä»¬ä¼šè¯„ä¼°å¹¶ååŠ©æ­å»ºã€‚</p>
      </div>

      <div class="card contact">
        <h3>ğŸ“ è”ç³»æˆ‘ä»¬</h3>
        <p>å¦‚éœ€åˆä½œã€å»ºè®®æˆ–æƒ³åˆ›å»ºæ–°çš„åˆ†ç»„ï¼Œè¯·åœ¨ä¸»ç¾¤å†…è”ç³»ç®¡ç†å‘˜æˆ–é€šè¿‡ä¸‹æ–¹ç•™è¨€æ¿ç•™è¨€ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚</p>
        <p>æŠ•ç¨¿æ¶¦å­¦å‘¨æŠ¥è¯·<b>ä¸è¦</b>ä½¿ç”¨ä¸‹æ–¹ç•™è¨€æ¿ï¼è¯·ç›´æ¥å‘é‚®ä»¶åˆ° weeklyupdate@vineshore.org</p>
        <p>å…³æ³¨æ¶¦å­¦å‘¨æŠ¥ï¼Œè·å–æˆ‘ä»¬çš„æœ€æ–°æ•´ç†ä¸å…¬å‘Šã€‚</p>
        <form @submit.prevent="submitForm" class="contact-form" novalidate>
          <div class="form-row">
            <label for="cf-name">å§“åï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" v-model="form.name" id="cf-name" name="name" placeholder="æ‚¨çš„å§“å" required>
          </div>

          <div class="form-row">
            <label for="cf-email">é‚®ç®±ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="email" v-model="form.email" id="cf-email" name="email" placeholder="name@example.com" required>
          </div>

          <div class="form-row">
            <label for="cf-qq">QQï¼ˆé€‰å¡«ï¼‰</label>
            <input type="text" v-model="form.qq" id="cf-qq" name="qq" placeholder="æ‚¨çš„QQå·ï¼ˆå¯ä¸å¡«ï¼‰" inputmode="numeric">
          </div>

          <div class="form-row">
            <label for="cf-message">ç•™è¨€å†…å®¹ï¼ˆå¿…å¡«ï¼‰</label>
            <textarea v-model="form.message" id="cf-message" name="message" rows="6" placeholder="è¯·æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®â€¦" required></textarea>
          </div>

          <input type="text" v-model="form.honey" id="cf-website" name="website" tabindex="-1" autocomplete="off" style="display:none">

          <div class="form-row">
            <div ref="turnstileContainer" class="cf-turnstile"></div>
          </div>

          <div class="form-actions">
            <button type="submit" id="cf-submit" :disabled="submitting">å‘é€ç•™è¨€</button>
            <span id="cf-status" role="status" aria-live="polite">{{ statusMessage }}</span>
          </div>
        </form>

        <router-link to="/" class="link-btn" style="margin-top:16px">è¿”å›ä¸»é¡µ â†’</router-link>
      </div>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';

const form = ref({
  name: '',
  email: '',
  qq: '',
  message: '',
  honey: ''
});
const statusMessage = ref('');
const submitting = ref(false);
const turnstileContainer = ref(null);
let tsToken = '';

// Use test sitekey for localhost, production sitekey for production
const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
const sitekey = isLocalhost ? '1x00000000000000000000AA' : '0x4AAAAAAB3z0RR14y0mYVTp';

const onTurnstileVerified = (token) => {
  tsToken = token || '';
};

// Make it globally accessible for the Turnstile script
window.onTurnstileVerified = onTurnstileVerified;

function validateEmail(v) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
function validateQQ(v) { if (!v) return true; return /^[1-9]\d{4,}$/.test(v); }

async function submitForm() {
  if (form.value.honey) return;
  if (!form.value.name) return statusMessage.value = 'è¯·å¡«å†™å§“å';
  if (!validateEmail(form.value.email)) return statusMessage.value = 'è¯·å¡«å†™æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
  if (!validateQQ(form.value.qq)) return statusMessage.value = 'QQå·æ ¼å¼ä¸æ­£ç¡®';
  if (!form.value.message) return statusMessage.value = 'è¯·å¡«å†™ç•™è¨€å†…å®¹';
  if (form.value.message.length > 4000) return statusMessage.value = 'å†…å®¹è¿‡é•¿ï¼Œè¯·ç²¾ç®€åå†æäº¤';

  if (!tsToken) {
    statusMessage.value = 'è¯·å…ˆå®ŒæˆäººæœºéªŒè¯';
    return;
  }

  statusMessage.value = 'å‘é€ä¸­â€¦';
  submitting.value = true;

  const payload = {
    name: form.value.name,
    email: form.value.email,
    qq: form.value.qq,
    message: form.value.message,
    cf_turnstile_response: tsToken
  };

  try {
    const res = await fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      cache: 'no-store',
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok) {
      statusMessage.value = 'å‘é€æˆåŠŸï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚';
      form.value = { name: '', email: '', qq: '', message: '', honey: '' };
      tsToken = '';
      try { if (window.turnstile) window.turnstile.reset(); } catch (_) {}
    } else {
      if (res.status === 403) {
        statusMessage.value = data.message || 'éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°å®ŒæˆäººæœºéªŒè¯';
        tsToken = '';
        try { if (window.turnstile) window.turnstile.reset(); } catch (_) {}
      } else {
        statusMessage.value = data.message || 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
      }
    }
  } catch (err) {
    statusMessage.value = 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•';
  } finally {
    submitting.value = false;
  }
}

onMounted(() => {
  // Check if Turnstile script is already loaded
  if (window.turnstile) {
    // Script already loaded, render immediately
    if (turnstileContainer.value) {
      try {
        window.turnstile.render(turnstileContainer.value, {
          sitekey: sitekey,
          callback: onTurnstileVerified,
          size: 'compact'
        });
      } catch (e) {
        console.error('Failed to render Turnstile:', e);
      }
    }
  } else {
    // Load script and render when ready
    const script = document.createElement('script');
    script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback';
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);

    window.onloadTurnstileCallback = () => {
      if (turnstileContainer.value) {
        try {
          window.turnstile.render(turnstileContainer.value, {
            sitekey: sitekey,
            callback: onTurnstileVerified,
            size: 'compact'
          });
        } catch (e) {
          console.error('Failed to render Turnstile:', e);
        }
      }
    };
  }
});

onUnmounted(() => {
  // Clean up the global callback
  delete window.onTurnstileVerified;
  delete window.onloadTurnstileCallback;
});
</script>

<style scoped>
.content h3{
  font-size:20px;
  margin:0 0 16px 0;
}

/* æ·±è‰²ä¸»é¢˜ */
[data-theme="dark"] .content h3 {
  color:#e6eef8;
}

/* æµ…è‰²ä¸»é¢˜ */
[data-theme="light"] .content h3 {
  color:#1a365d;
}

.content p{
  color:var(--muted);
  line-height:1.7;
  margin:0 0 16px 0;
}
.content p:last-child{
  margin-bottom:0;
}

.features{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
  margin-top:20px;
}
.feature{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:10px;
  padding:20px;
  text-align:center;
}
.feature-icon{
  font-size:32px;
  margin-bottom:12px;
}
.feature h4{
  margin:0 0 8px 0;
  font-size:16px;
}
.feature p{
  margin:0;
  font-size:14px;
  color:var(--muted);
}

.contact{
  background:rgba(110,168,254,0.05);
  border:1px solid rgba(110,168,254,0.2);
}
.contact h3{
  color:var(--accent);
}

.link-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  border-radius:8px;
  background:linear-gradient(90deg,var(--accent),#7dd3fc);
  color:#04263b;
  text-decoration:none;
  font-weight:600;
  margin-top:12px;
  transition:transform 0.2s ease;
}
.link-btn:hover{
  transform:translateY(-1px);
}

/* ç•™è¨€è¡¨å•çš„å±€éƒ¨æ ·å¼ */
.contact-form{ margin-top:10px }
.contact-form .form-row{ display:flex;flex-direction:column;gap:6px;margin-bottom:12px }
.contact-form label{ font-size:13px;color:#b9c6d3 }

/* è¡¨å•è¾“å…¥æ¡† - æ·±è‰²ä¸»é¢˜ */
[data-theme="dark"] .contact-form input,
[data-theme="dark"] .contact-form textarea{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.08);
  color:#e6eef8;
  border-radius:8px;
  padding:10px 12px;
  outline:none;
}

/* è¡¨å•è¾“å…¥æ¡† - æµ…è‰²ä¸»é¢˜ */
[data-theme="light"] .contact-form input,
[data-theme="light"] .contact-form textarea{
  background:rgba(255,255,255,0.8);
  border:1px solid rgba(0,0,0,0.15);
  color:#1a365d;
  border-radius:8px;
  padding:10px 12px;
  outline:none;
}

[data-theme="light"] .contact-form input::placeholder,
[data-theme="light"] .contact-form textarea::placeholder{
  color:#64748b;
}

.contact-form input:focus,.contact-form textarea:focus{ border-color: var(--accent) }
.contact-form .form-actions{ display:flex;align-items:center;gap:12px;margin-top:8px }
#cf-submit{
  background:linear-gradient(90deg,var(--accent),#7dd3fc);
  color:#04263b; border:0; border-radius:8px; padding:10px 16px;
  font-weight:600; cursor:pointer; transition:opacity .2s ease,transform .2s ease
}
#cf-submit:disabled{ opacity:.6; cursor:default }
#cf-status{ font-size:13px;color:var(--muted) }

@media (max-width:880px){
  .card{padding:20px}
  .hero h2{font-size:28px}
  .features{grid-template-columns:1fr}
}
</style>
